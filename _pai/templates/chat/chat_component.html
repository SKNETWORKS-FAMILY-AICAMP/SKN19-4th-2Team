{% load static %}
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dompurify/dist/purify.min.js"></script>

<div id="ai-chat-widget-container">
    <input type="hidden" id="current-history-id" value="{{ selected_history_id }}">

    <div id="chat-history">
        {% if chat_history %}
        {% for msg in chat_history %}
        {% if msg.type != 'TOOLS' %}
        <div id="row-{{ msg.chat_id }}"
            class="chat-row {% if msg.type == 'HUMAN' %}user-row{% else %}ai-row{% endif %}">
            {% if msg.type == 'HUMAN' %}
            <button class="delete-btn" onclick="deleteMessage('{{ msg.chat_id }}')" title="ëŒ€í™” ì‚­ì œ">ğŸ—‘ï¸</button>
            {% else %}
            <img src="{% static 'images/chat_pai.png' %}" alt="Pai Avatar" class="ai-avatar">
            {% endif %}

            <div
                class="chat-message {% if msg.type == 'HUMAN' %}user-message{% else %}ai-message markdown-target{% endif %}">
                {% if msg.type == 'HUMAN' %}
                {{ msg.content|linebreaksbr }}
                {% endif %}
            </div>

            {% if msg.type == 'AI' %}
            <div class="raw-data" style="display:none;">{{ msg.content }}</div>
            {% endif %}
        </div>
        {% endif %}
        {% endfor %}
        {% else %}
        <div class="chat-row ai-row">
            <img src="{% static 'images/chat_pai.png' %}" alt="Pai Avatar" class="ai-avatar">
            <div class="chat-message ai-message">
            ì•ˆë…•í•˜ì„¸ìš”! 
            <b>
                {% if user.is_authenticated %}
                    {{ user.last_name }}{{ user.first_name }}ë‹˜
                {% else %}
                    ë°©ë¬¸ìë‹˜
                {% endif %}
            </b> ğŸ‘‹<br>
            ì €ëŠ” <b>Pai(Patent AI)</b>, 
            <b>ì»´í“¨í„° ë¹„ì „ ë¶„ì•¼ íŠ¹í—ˆì— íŠ¹í™”ëœ AI ì–´ì‹œìŠ¤í„´íŠ¸</b>ì…ë‹ˆë‹¤.<br>
            ì‚¬ìš©ìì˜ ì•„ì´ë””ì–´ë¥¼ ë¶„ì„í•˜ê³ , ë‚´ë¶€ íŠ¹í—ˆÂ·IPC DBë¥¼ í™œìš©í•˜ì—¬<br>
            <b>ìœ ì‚¬ íŠ¹í—ˆ ê²€ìƒ‰ Â· IPC ì½”ë“œ ì¶”ì²œ Â· IPC ì½”ë“œ ì„¤ëª… Â· ê¸°ë³¸ íŠ¹í—ˆ ì‹¤ë¬´ ì•ˆë‚´</b>ë¥¼ ë„ì™€ë“œë ¤ìš”.<br>
            <br>
            <b>ì´ëŸ° ê±¸ ë„ì™€ë“œë¦´ ìˆ˜ ìˆì–´ìš”</b><br>
            - ë°œëª… ì•„ì´ë””ì–´ë¥¼ ë°”íƒ•ìœ¼ë¡œ ìœ ì‚¬í•œ ê³µê°œÂ·ë“±ë¡ íŠ¹í—ˆë¥¼ ì°¾ì•„ í•µì‹¬ë§Œ ìš”ì•½í•´ ë“œë¦¬ê¸°<br>
            - ì•„ì´ë””ì–´ì— ì–´ìš¸ë¦´ ë§Œí•œ êµ­ì œíŠ¹í—ˆë¶„ë¥˜(IPC) ì½”ë“œ í›„ë³´ë¥¼ ì¶”ì²œí•´ ë“œë¦¬ê¸°<br>
            - ì´ë¯¸ ì•Œê³  ìˆëŠ” IPC ì½”ë“œ(ì˜ˆ: G06T 7/00, H04N 5/232)ì˜ ì˜ë¯¸ì™€ ìƒìœ„Â·í•˜ìœ„ êµ¬ì¡° ì„¤ëª…<br>
            - íŠ¹ì • ì¶œì›ë²ˆí˜¸(ì˜ˆ: 10-2023-0112930)ì˜ ëŒ€í‘œ ì²­êµ¬í•­ì„ ëª¨ì•„ì„œ ìš”ì•½ ì •ë¦¬<br>
            - ì»´í“¨í„° ë¹„ì „ ê´€ë ¨ íŠ¹í—ˆ ì‹¤ë¬´ ê°œë…ì„ ì´í•´í•˜ê¸° ì‰½ê²Œ í’€ì–´ì„œ ì„¤ëª…<br>
            <br>
            <b>ì˜ˆì‹œë¡œ ì´ë ‡ê²Œ ë¬¼ì–´ë³´ì‹¤ ìˆ˜ ìˆì–´ìš”</b><br>
            - "ì°¨ëŸ‰ ì „ë°© ì¹´ë©”ë¼ë¡œ ë³´í–‰ìë¥¼ ì¸ì‹í•´ì„œ ìë™ ì œë™í•˜ëŠ” ì‹œìŠ¤í…œì¸ë°, ë¹„ìŠ·í•œ íŠ¹í—ˆë¥¼ ì°¾ì•„ì¤˜."<br>
            - "ì´ ì•„ì´ë””ì–´ì— ì–´ìš¸ë¦¬ëŠ” IPC ì½”ë“œë¥¼ ì¶”ì²œí•´ì¤˜."<br>
            - "IPC ì½”ë“œ G06T 7/00ì´ ì–´ë–¤ ê¸°ìˆ ì„ ë‹¤ë£¨ëŠ”ì§€ ì„¤ëª…í•´ì¤˜."<br>
            - "ì¶œì›ë²ˆí˜¸ 1020230019980 íŠ¹í—ˆì˜ ì£¼ìš” ì²­êµ¬í•­ë“¤ì„ ìš”ì•½í•´ì¤˜."<br>
            <br><b>ì°¸ê³ í•´ì£¼ì„¸ìš”</b><br>
            - í˜„ì¬ DBëŠ” ì£¼ë¡œ <b>ì»´í“¨í„° ë¹„ì „ ê´€ë ¨ íŠ¹í—ˆ</b>ë¥¼ ì¤‘ì‹¬ìœ¼ë¡œ ë˜ì–´ ìˆì–´ì„œ,<br>
            í™”í•™Â·ì˜ë£ŒÂ·ë†ê¸°ê³„ ë“± ë‹¤ë¥¸ ë¶„ì•¼ íŠ¹í—ˆëŠ” ì¶©ë¶„í•˜ì§€ ì•Šì„ ìˆ˜ ìˆì–´ìš”.<br>
            - ì‹¤ì œ ì¶œì›, ê¶Œë¦¬ë²”ìœ„ íŒë‹¨ì²˜ëŸ¼ ë²•ì  ì±…ì„ì´ í•„ìš”í•œ ê²°ì •ì€<br>
            ë°˜ë“œì‹œ ë³€ë¦¬ì‚¬ì˜ ê²€í† ì™€ í•¨ê»˜ ì§„í–‰í•´ ì£¼ì„¸ìš”.<br>
            <br>
            ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”?
            </div>
        </div>

        {% endif %}
    </div>

    <form id="chat-input-area" onsubmit="sendMessage(event)">
        <div class="view-mode-wrapper">
            <button type="button" id="view-mode-btn" title="ë³´ê¸° ëª¨ë“œ ë³€ê²½">
                </button>
            <div id="view-mode-menu" class="view-mode-menu">
                </div>
        </div>

        <input type="text" id="user-input" placeholder="ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”..." autocomplete="off">
        <button type="submit" id="send-btn">ì „ì†¡</button>
    </form>
</div>

<style>
    /* ========================================
     1. ì „ì²´ ë ˆì´ì•„ì›ƒ & ê¸°ë³¸ ì„¤ì •
     ========================================
    */
    #ai-chat-widget-container {
        width: 100%;
        max-width: 900px;
        margin: 0 auto;
        border: 1px solid #e1e4e8;
        border-radius: 16px;
        background-color: #f8f9fa;
        display: flex;
        flex-direction: column;
        height: 100%;
        font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.05);
        position: relative;
    }

    #chat-history {
        flex: 1;
        padding: 24px;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 20px;
        scroll-behavior: smooth;
    }

    #chat-history::-webkit-scrollbar { width: 6px; }
    #chat-history::-webkit-scrollbar-thumb { background-color: #d1d5db; border-radius: 3px; }
    #chat-history::-webkit-scrollbar-track { background-color: transparent; }

    /* ========================================
     2. ì±„íŒ… ë©”ì‹œì§€ (ë§í’ì„ )
     ========================================
    */
    .chat-row {
        display: flex;
        width: 100%;
        align-items: flex-start;
        gap: 12px;
    }
    .user-row { justify-content: flex-end; }
    .ai-row { justify-content: flex-start; }

    .ai-avatar {
        width: 36px;
        height: 36px;
        border-radius: 12px;
        margin-top: 4px;
        flex-shrink: 0;
        object-fit: cover;
        border: 1px solid #f1f3f5;
        background-color: #fff;
        box-shadow: 0 2px 4px rgba(0,0,0,0.03);
    }

    .chat-message {
        max-width: 85%;
        padding: 14px 18px;
        border-radius: 16px;
        font-size: 15px;
        line-height: 1.6;
        word-wrap: break-word;
        position: relative;
        box-shadow: 0 1px 2px rgba(0,0,0,0.04);
    }

    .user-message {
        background-color: #4a5c8d;
        color: #fff;
        border-bottom-right-radius: 4px;
    }

    .ai-message {
        background-color: #ffffff;
        color: #1f2937;
        border: 1px solid #e5e7eb;
        border-bottom-left-radius: 4px;
        min-width: 320px;
    }

    .delete-btn {
        opacity: 0; transition: all 0.2s;
        background: none; border: none; cursor: pointer; 
        font-size: 14px; padding: 4px; color: #adb5bd;
    }
    .delete-btn:hover { color: #fa5252; transform: scale(1.1); }
    .chat-row:hover .delete-btn { opacity: 1; }

    .tool-status {
        font-size: 12px; color: #6b7280;
        background-color: #f3f4f6;
        padding: 6px 12px; border-radius: 20px;
        display: inline-flex; align-items: center; gap: 8px;
        margin-left: 48px; margin-bottom: 4px;
    }
    .spinner {
        width: 10px; height: 10px; border: 2px solid #d1d5db;
        border-top-color: #4a5c8d; border-radius: 50%;
        animation: spin 0.8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* ========================================
     3. ì…ë ¥ ì˜ì—­ & ë³´ê¸° ëª¨ë“œ ë²„íŠ¼
     ========================================
    */
    #chat-input-area {
        padding: 16px 20px;
        background-color: #ffffff;
        border-top: 1px solid #f1f3f5;
        border-bottom-left-radius: 16px;
        border-bottom-right-radius: 16px;
        display: flex; gap: 12px; align-items: center;
        position: relative;
    }

    .view-mode-wrapper { position: relative; display: flex; align-items: center; }
    
    #view-mode-btn {
        width: 40px; height: 40px;
        border-radius: 10px;
        border: 1px solid #e5e7eb;
        background-color: #fff;
        color: #4b5563;
        cursor: pointer;
        display: flex; align-items: center; justify-content: center;
        transition: all 0.2s ease;
    }
    #view-mode-btn:hover { background-color: #f9fafb; border-color: #d1d5db; color: #111827; }
    #view-mode-btn svg { width: 20px; height: 20px; fill: none; stroke: currentColor; stroke-width: 2; }

    .view-mode-menu {
        position: absolute; bottom: 50px; left: 0;
        width: 180px;
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        display: none; flex-direction: column; overflow: hidden; z-index: 50;
        padding: 4px;
        animation: slideUp 0.2s ease-out;
    }
    .view-mode-menu.show { display: flex; }
    @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    .mode-item {
        padding: 10px 12px; font-size: 13px; font-weight: 500;
        color: #374151; cursor: pointer; border-radius: 8px;
        display: flex; align-items: center; gap: 10px; transition: background 0.1s;
    }
    .mode-item:hover { background-color: #f3f4f6; }
    .mode-item.active { background-color: #eff6ff; color: #2563eb; }
    .mode-item svg { width: 16px; height: 16px; stroke-width: 2; }

    #user-input {
        flex: 1; padding: 12px 16px;
        border: 1px solid #e5e7eb; border-radius: 10px;
        font-size: 15px; outline: none; transition: all 0.2s;
        background-color: #f9fafb;
    }
    #user-input:focus { border-color: #4a5c8d; background-color: #fff; box-shadow: 0 0 0 3px rgba(74, 92, 141, 0.1); }

    #send-btn {
        height: 40px; padding: 0 20px;
        background-color: #4a5c8d; color: #fff;
        border: none; border-radius: 10px;
        font-weight: 600; font-size: 14px; cursor: pointer;
        transition: background 0.2s;
    }
    #send-btn:hover { background-color: #3b4c6e; }
    #send-btn:disabled { background-color: #cbd5e1; cursor: not-allowed; }

    /* ========================================
     4. ë§ˆí¬ë‹¤ìš´ ìŠ¤íƒ€ì¼
     ========================================
    */
    .ai-message h1, .ai-message h2, .ai-message h3 { margin-top: 16px; color: #111827; }
    .ai-message h1 { font-size: 1.25em; border-bottom: 2px solid #f3f4f6; padding-bottom: 8px; }
    .ai-message p { margin-bottom: 12px; line-height: 1.6; color: #374151; }
    .ai-message code { background: #f3f4f6; color: #e11d48; padding: 2px 6px; border-radius: 4px; font-size: 0.9em; font-family: 'Menlo', monospace; }
    .ai-message pre { background: #1e293b; color: #f8fafc; padding: 12px; border-radius: 8px; overflow-x: auto; margin: 12px 0; }
    .ai-message pre code { background: transparent; color: inherit; padding: 0; }
    .ai-message ul { padding-left: 20px; color: #374151; }

    /* ========================================
     5. ì¹´ë“œ ë·° ìŠ¤íƒ€ì¼ (Capsule/Pill Footer)
     ========================================
    */
    .card-container {
        display: flex; flex-direction: column; height: 100%;
    }
    
    .card-content {
        flex: 1;
        animation: fadeIn 0.3s ease;
        min-height: 80px; 
        padding-bottom: 4px;
    }

    /* [ìˆ˜ì •] ì¹´ë“œ í•˜ë‹¨ë°”: ì™„ì „í•œ ì•Œì•½ í˜•íƒœ */
    .card-footer {
        margin-top: 0px;
        background-color: #ffffff; /* íšŒìƒ‰ ë°°ê²½ */
        
        /* [í•µì‹¬] ë‘¥ê·¼ ì •ë„ë¥¼ 50pxë¡œ ëŠ˜ë ¤ ì™„ë²½í•œ ë°˜ì›ì„ ë§Œë“­ë‹ˆë‹¤ */
        border-radius: 50px; 
        
        /* [í•µì‹¬] íŒ¨ë”©ì„ ëŠ˜ë ¤ ì»¨í…ì¸ ê°€ ëª¨ì„œë¦¬ì— ë¶™ì§€ ì•Šê²Œ í•©ë‹ˆë‹¤ */
        padding: 8px 16px; 
        border-top:none;
        display: flex; justify-content: space-between; align-items: center;
    }

    .card-nav-btn {
        width: 28px; height: 28px;
        border-radius: 50%; 
        border: 1px solid #e9ecef;
        background: #fff; 
        color: #4b5563;
        display: flex; align-items: center; justify-content: center;
        cursor: pointer; transition: all 0.2s;
        box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }
    .card-nav-btn:hover:not(:disabled) { 
        background-color: #fff; border-color: #adb5bd; 
        color: #111827; transform: scale(1.05); 
    }
    .card-nav-btn:disabled { 
        opacity: 0.4; cursor: not-allowed; background-color: #f1f3f5; border-color: transparent; box-shadow: none;
    }
    .card-nav-btn svg { width: 14px; height: 14px; stroke-width: 2.5; }

    .page-indicator {
        font-size: 11px; font-weight: 600; color: #868e96;
        background: transparent; padding: 0 8px;
        user-select: none;
    }

    /* ========================================
     6. ì ‘ì–´ì„œ ë³´ê¸° (Clean)
     ========================================
    */
    .expandable-container {
        position: relative; overflow: hidden;
        transition: max-height 0.4s cubic-bezier(0, 1, 0, 1);
        border-radius: 8px;
    }
    
    .expandable-container.collapsed {
        max-height: 140px; 
    }

    .gradient-overlay {
        position: absolute; bottom: 0; left: 0; width: 100%; height: 80px;
        background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,1) 65%);
        display: flex; align-items: flex-end; justify-content: center;
        padding-bottom: 0; 
        pointer-events: none; opacity: 0; transition: opacity 0.3s;
    }
    .expandable-container.collapsed .gradient-overlay { opacity: 1; pointer-events: auto; }

    .collapse-footer {
        display: none; justify-content: center; 
        margin-top: 12px; padding-top: 12px; 
        border-top: 1px dashed #e9ecef;
        background-color: transparent;
    }
    .expandable-container:not(.collapsed) .collapse-footer { display: flex; }

    .expand-pill-btn {
        background-color: white;
        border: 1px solid #e9ecef;
        box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        padding: 5px 14px; border-radius: 100px;
        color: #4a5c8d; font-size: 12px; font-weight: 600;
        cursor: pointer; display: flex; align-items: center; gap: 4px;
        transition: all 0.2s;
    }
    
    .gradient-overlay .expand-pill-btn {
        margin-bottom: 10px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }
    
    .collapse-footer .expand-pill-btn {
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        width: auto;
        box-shadow: none;
    }

    .expand-pill-btn:hover { 
        transform: translateY(-1px); color: #3b4c6e; border-color: #ced4da;
    }
    .expand-pill-btn svg { width: 10px; height: 10px; stroke-width: 3; }

    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
</style>

<script>
    // ============================================================
    // 0. ì•„ì´ì½˜ ë¦¬ì†ŒìŠ¤ (SVG)
    // ============================================================
    const ICONS = {
        viewMode: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="3" y1="9" x2="21" y2="9"></line><line x1="9" y1="21" x2="9" y2="9"></line></svg>`,
        card: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="9"></rect><rect x="14" y="3" width="7" height="5"></rect><rect x="14" y="12" width="7" height="9"></rect><rect x="3" y="16" width="7" height="5"></rect></svg>`,
        full: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>`,
        expand: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M4 14h6v6"></path><path d="M20 10h-6V4"></path><path d="M14 10l7-7"></path><path d="M3 21l7-7"></path></svg>`,
        chevronDown: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><polyline points="6 9 12 15 18 9"></polyline></svg>`,
        chevronUp: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><polyline points="18 15 12 9 6 15"></polyline></svg>`,
        arrowLeft: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><polyline points="15 18 9 12 15 6"></polyline></svg>`,
        arrowRight: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><polyline points="9 18 15 12 9 6"></polyline></svg>`
    };

    // ============================================================
    // 1. ì „ì—­ ë³€ìˆ˜ ë° ì´ˆê¸°í™”
    // ============================================================
    const chatHistory = document.getElementById('chat-history');
    const userInput = document.getElementById('user-input');
    const sendBtn = document.getElementById('send-btn');
    const historyIdInput = document.getElementById('current-history-id');
    const viewModeBtn = document.getElementById('view-mode-btn');
    const viewModeMenu = document.getElementById('view-mode-menu');

    let currentViewMode = localStorage.getItem('pai_view_mode') || 'card';
    let isAutoScrollActive = true;

    window.addEventListener('DOMContentLoaded', () => {
        viewModeBtn.innerHTML = ICONS.viewMode;
        viewModeMenu.innerHTML = `
            <div class="mode-item" onclick="changeViewMode('card')">${ICONS.card} ì¹´ë“œ ë³´ê¸°</div>
            <div class="mode-item" onclick="changeViewMode('full')">${ICONS.full} ì „ì²´ ë³´ê¸°</div>
            <div class="mode-item" onclick="changeViewMode('accordion')">${ICONS.expand} ì ‘ì–´ì„œ ë³´ê¸°</div>
        `;
        updateMenuState(currentViewMode);
        refreshAllMessages(); 
        forceScrollToBottom();
    });

    viewModeBtn.addEventListener('click', (e) => { e.stopPropagation(); viewModeMenu.classList.toggle('show'); });
    document.addEventListener('click', () => { viewModeMenu.classList.remove('show'); });
    chatHistory.addEventListener('scroll', () => {
        const diff = chatHistory.scrollHeight - (chatHistory.scrollTop + chatHistory.clientHeight);
        isAutoScrollActive = (diff <= 50);
    });

    // ============================================================
    // 2. ë³´ê¸° ëª¨ë“œ ë¡œì§
    // ============================================================
    function changeViewMode(mode) {
        currentViewMode = mode;
        localStorage.setItem('pai_view_mode', mode);
        updateMenuState(mode);
        refreshAllMessages();
    }
    function updateMenuState(mode) {
        const items = viewModeMenu.querySelectorAll('.mode-item');
        items.forEach(item => {
            if (item.getAttribute('onclick').includes(`'${mode}'`)) item.classList.add('active');
            else item.classList.remove('active');
        });
    }
    function refreshAllMessages() {
        const targets = document.querySelectorAll('.markdown-target');
        targets.forEach(targetDiv => {
            const raw = targetDiv.closest('.chat-row').querySelector('.raw-data');
            if (raw) renderContentByMode(targetDiv, raw.textContent);
        });
        viewModeMenu.classList.remove('show');
    }

    // ============================================================
    // 3. ë Œë”ë§ í•¨ìˆ˜
    // ============================================================
    function renderContentByMode(targetDiv, markdownText) {
        targetDiv.innerHTML = ''; 

        // 1. Full Mode
        if (currentViewMode === 'full') {
            targetDiv.innerHTML = DOMPurify.sanitize(marked.parse(markdownText));
        }
        
        // 2. Expand Mode (Clean Style)
        else if (currentViewMode === 'accordion') {
            const htmlContent = DOMPurify.sanitize(marked.parse(markdownText));
            const container = document.createElement('div');
            container.className = 'expandable-container';
            const contentInner = document.createElement('div');
            contentInner.innerHTML = htmlContent;
            container.appendChild(contentInner);

            const overlay = document.createElement('div');
            overlay.className = 'gradient-overlay';
            overlay.innerHTML = `<button class="expand-pill-btn">í¼ì¹˜ê¸° ${ICONS.chevronDown}</button>`;
            
            const footer = document.createElement('div');
            footer.className = 'collapse-footer';
            footer.innerHTML = `<button class="expand-pill-btn">ì ‘ê¸° ${ICONS.chevronUp}</button>`;

            container.appendChild(overlay);
            container.appendChild(footer);
            targetDiv.appendChild(container);

            const expandBtn = overlay.querySelector('button');
            const collapseBtn = footer.querySelector('button');

            requestAnimationFrame(() => {
                if (contentInner.scrollHeight > 180) container.classList.add('collapsed');
                else { overlay.style.display = 'none'; footer.style.display = 'none'; }
            });

            expandBtn.onclick = (e) => { e.stopPropagation(); container.classList.remove('collapsed'); };
            collapseBtn.onclick = (e) => { e.stopPropagation(); container.classList.add('collapsed'); };
        }
        
        // 3. Card Mode (Capsule Footer)
        else {
            const parts = markdownText.split(/\n\s*---\s*\n/);
            if (parts.length <= 1) { targetDiv.innerHTML = DOMPurify.sanitize(marked.parse(markdownText)); return; }

            const pages = parts.map(part => DOMPurify.sanitize(marked.parse(part)));
            let currentPage = 0;

            const container = document.createElement('div');
            container.className = 'card-container';
            const contentDiv = document.createElement('div');
            contentDiv.className = 'card-content';
            contentDiv.innerHTML = pages[0];

            // Capsule Footer
            const footer = document.createElement('div');
            footer.className = 'card-footer';
            const prevBtn = document.createElement('button');
            prevBtn.className = 'card-nav-btn'; prevBtn.innerHTML = ICONS.arrowLeft; prevBtn.disabled = true;
            const nextBtn = document.createElement('button');
            nextBtn.className = 'card-nav-btn'; nextBtn.innerHTML = ICONS.arrowRight;
            const indicator = document.createElement('span');
            indicator.className = 'page-indicator'; indicator.innerText = `1 / ${pages.length}`;

            const updateState = () => {
                contentDiv.innerHTML = pages[currentPage];
                indicator.innerText = `${currentPage + 1} / ${pages.length}`;
                prevBtn.disabled = (currentPage === 0);
                nextBtn.disabled = (currentPage === pages.length - 1);
            };

            prevBtn.onclick = () => { if (currentPage > 0) { currentPage--; updateState(); } };
            nextBtn.onclick = () => { if (currentPage < pages.length - 1) { currentPage++; updateState(); } };

            footer.appendChild(prevBtn);
            footer.appendChild(indicator);
            footer.appendChild(nextBtn);
            container.appendChild(contentDiv);
            container.appendChild(footer);
            targetDiv.appendChild(container);
        }
    }

    // ============================================================
    // 4. ë©”ì‹œì§€ ì „ì†¡ ë° ê¸°ë³¸ ë¡œì§
    // ============================================================
    async function sendMessage(event) {
        event.preventDefault();
        const text = userInput.value.trim();
        const historyId = historyIdInput.value;
        if (!text || !historyId) return;

        const currentUserRow = appendMessage('user', text);
        userInput.value = ''; userInput.disabled = true; sendBtn.disabled = true;
        forceScrollToBottom();

        try {
            const response = await fetch('/chat/api/stream/', {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: text, history_id: historyId })
            });

            if (!response.ok) throw new Error(await response.text());

            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let currentAiBubble = null;
            let currentContent = "";

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;
                const chunk = decoder.decode(value, { stream: true });
                const lines = chunk.split('\n');

                for (const line of lines) {
                    if (!line.trim()) continue;
                    try {
                        const data = JSON.parse(line);
                        if (data.type === 'user_message_id') {
                            if (currentUserRow) {
                                currentUserRow.id = 'row-' + data.chat_id;
                                addDeleteButton(currentUserRow, data.chat_id);
                            }
                        } else if (data.type === 'token') {
                            removeToolStatus();
                            if (!currentAiBubble) currentAiBubble = createMessageBubble('ai');
                            currentContent += data.content;
                            currentAiBubble.innerHTML = DOMPurify.sanitize(marked.parse(currentContent));
                        } else if (data.type === 'tool_call') createToolStatus(data.tool_name);
                        else if (data.type === 'history_title') {
                            if (typeof updateHistoryTitle === 'function') updateHistoryTitle(data.history_id, data.title);
                        }
                        scrollToBottom();
                    } catch (e) {}
                }
            }
            if (currentAiBubble && currentContent) renderContentByMode(currentAiBubble, currentContent);
        } catch (error) {
            removeToolStatus();
            appendMessage('ai', "âš ï¸ ì˜¤ë¥˜ ë°œìƒ: " + error.message);
        } finally {
            removeToolStatus();
            userInput.disabled = false; sendBtn.disabled = false;
            userInput.focus(); scrollToBottom();
        }
    }

    function scrollToBottom() { if (isAutoScrollActive) chatHistory.scrollTop = chatHistory.scrollHeight; }
    function forceScrollToBottom() { isAutoScrollActive = true; chatHistory.scrollTop = chatHistory.scrollHeight; }
    function removeToolStatus() { chatHistory.querySelectorAll('.tool-status').forEach(el => el.remove()); }
    function createToolStatus(toolName) {
        removeToolStatus();
        const div = document.createElement('div'); div.className = 'tool-status';
        div.innerHTML = `<div class="spinner"></div><span>${toolName}...</span>`;
        chatHistory.appendChild(div); scrollToBottom();
    }
    function createMessageBubble(role) {
        const row = document.createElement('div'); row.className = `chat-row ${role==='user'?'user-row':'ai-row'}`;
        if(role==='ai'){
            const img = document.createElement('img'); img.src = "{% static 'images/chat_pai.png' %}";
            img.className = 'ai-avatar'; row.appendChild(img);
        }
        const msg = document.createElement('div'); msg.className = `chat-message ${role==='user'?'user-message':'ai-message'}`;
        if(role==='ai') msg.classList.add('markdown-target');
        row.appendChild(msg); chatHistory.appendChild(row);
        return role==='user'? row : msg;
    }
    function appendMessage(role, text) {
        const row = createMessageBubble(role);
        row.querySelector('.chat-message').innerText = text; return row;
    }
    function addDeleteButton(row, id) {
        const btn = document.createElement('button'); btn.className='delete-btn'; btn.innerHTML='âœ•';
        btn.onclick=()=>deleteMessage(id); row.prepend(btn);
    }
    function deleteMessage(id) { 
        if(!confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
        fetch('/chat/api/delete/', {method:'POST', body:JSON.stringify({message_id:id})})
        .then(r=>r.json()).then(d=>{ if(d.status==='success') location.reload(); });
    }
</script>