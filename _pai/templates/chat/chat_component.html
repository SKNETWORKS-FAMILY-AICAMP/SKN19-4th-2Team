<div id="ai-chat-widget-container">

    <div id="chat-history">
        {% if chat_history %}
        {% for msg in chat_history %}

        {# 1. Tool ë©”ì‹œì§€ëŠ” ìˆ¨ê¹€ ì²˜ë¦¬ #}
        {% if msg.role != 'tool' %}

        {# 2. ë©”ì‹œì§€ í–‰(Row) ì¶”ê°€: ì •ë ¬ê³¼ ì‚­ì œ ë²„íŠ¼ ë°°ì¹˜ë¥¼ ìœ„í•´ ê°ìŒˆ #}
        <div class="chat-row {% if msg.role == 'user' %}user-row{% else %}ai-row{% endif %}">

            {# 3. ì‚¬ìš©ì ë©”ì‹œì§€ì¸ ê²½ìš°ì—ë§Œ ì™¼ìª½ì— íœ´ì§€í†µ ë²„íŠ¼ ìƒì„± #}
            {% if msg.role == 'user' %}
            <button class="delete-btn" onclick="deleteMessage('{{ msg.id }}')" title="ëŒ€í™” ì‚­ì œ">
                ğŸ—‘ï¸
            </button>
            {% endif %}

            <div class="chat-message {% if msg.role == 'user' %}user-message{% else %}ai-message{% endif %}">
                {{ msg.content|linebreaksbr }}
            </div>
        </div>

        {% endif %}

        {% endfor %}
        {% else %}
        <div class="chat-row ai-row">
            <div class="chat-message ai-message">
                ì•ˆë…•í•˜ì„¸ìš”! íŠ¹í—ˆ/ë¹„ì „ ì „ë¬¸ AIì…ë‹ˆë‹¤.<br>
                ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”?
            </div>
        </div>
        {% endif %}
    </div>

    <form id="chat-input-area" onsubmit="sendMessage(event)">
        <input type="text" id="user-input" placeholder="ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”..." autocomplete="off">
        <button type="submit" id="send-btn">ì „ì†¡</button>
    </form>
</div>

<style>
    /* =========================================
       1. ê¸°ì¡´ ìŠ¤íƒ€ì¼ (ê·¸ëŒ€ë¡œ ìœ ì§€)
       ========================================= */
    #ai-chat-widget-container {
        width: 100%;
        max-width: 800px;
        margin: 0 auto;
        border: 1px solid #ddd;
        border-radius: 12px;
        background-color: #f8f9fa;
        display: flex;
        flex-direction: column;
        height: 700px;
        font-family: 'Suit', sans-serif;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }

    #chat-history {
        flex: 1;
        padding: 20px;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .chat-message {
        max-width: 80%;
        padding: 10px 14px;
        border-radius: 10px;
        font-size: 15px;
        line-height: 1.5;
        word-wrap: break-word;
    }

    .user-message {
        /* align-selfëŠ” ì´ì œ chat-rowê°€ ëŒ€ì‹  ì²˜ë¦¬í•˜ë¯€ë¡œ ì œê±°í•´ë„ ë˜ì§€ë§Œ, 
           í˜¹ì‹œ ëª¨ë¥¼ í˜¸í™˜ì„±ì„ ìœ„í•´ ë‘¬ë„ í° ë¬¸ì œ ì—†ìŠµë‹ˆë‹¤. */
        background-color: #4a90e2;
        color: #fff;
        border-bottom-right-radius: 2px;
    }

    .ai-message {
        background-color: #fff;
        color: #333;
        border: 1px solid #e0e0e0;
        border-bottom-left-radius: 2px;
    }

    /* ë„êµ¬, ìŠ¤í”¼ë„ˆ ë“± ê¸°ì¡´ ìŠ¤íƒ€ì¼ */
    .tool-status {
        align-self: flex-start;
        font-size: 13px;
        color: #666;
        background-color: #e9ecef;
        padding: 6px 12px;
        border-radius: 15px;
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 5px;
    }

    .spinner {
        width: 12px;
        height: 12px;
        border: 2px solid #bdc3c7;
        border-top-color: #3498db;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        to {
            transform: rotate(360deg);
        }
    }

    #chat-input-area {
        padding: 15px;
        background-color: #fff;
        border-top: 1px solid #ddd;
        border-bottom-left-radius: 12px;
        border-bottom-right-radius: 12px;
        display: flex;
        gap: 10px;
    }

    #user-input {
        flex: 1;
        padding: 12px;
        border: 1px solid #ced4da;
        border-radius: 6px;
        outline: none;
    }

    #send-btn {
        padding: 0 20px;
        background-color: #4a90e2;
        color: #fff;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 600;
    }

    #send-btn:disabled {
        background-color: #aab2bd;
    }


    /* =========================================
       2. [ì¶”ê°€ë¨] ë°°ì¹˜ ë° ì‚­ì œ ë²„íŠ¼ ìŠ¤íƒ€ì¼
       ========================================= */

    /* ë©”ì‹œì§€ì™€ ë²„íŠ¼ì„ ê°ì‹¸ëŠ” í•œ ì¤„(Row) */
    .chat-row {
        display: flex;
        width: 100%;
        align-items: flex-end;
        /* ì•„ë˜ìª½ ë¼ì¸ ë§ì¶¤ */
        gap: 8px;
        /* ë²„íŠ¼ê³¼ ë©”ì‹œì§€ ì‚¬ì´ ê°„ê²© */
    }

    /* ì‚¬ìš©ì ë©”ì‹œì§€ëŠ” ì˜¤ë¥¸ìª½ ì •ë ¬ */
    .user-row {
        justify-content: flex-end;
    }

    /* AI ë©”ì‹œì§€ëŠ” ì™¼ìª½ ì •ë ¬ */
    .ai-row {
        justify-content: flex-start;
    }

    /* ì‚­ì œ ë²„íŠ¼ (íœ´ì§€í†µ) */
    .delete-btn {
        background: none;
        border: none;
        cursor: pointer;
        font-size: 14px;
        padding: 5px;
        opacity: 0;
        /* í‰ì†Œì—ëŠ” ìˆ¨ê¹€ */
        transition: opacity 0.2s;
    }

    /* ë§ˆìš°ìŠ¤ë¥¼ ì˜¬ë ¸ì„ ë•Œë§Œ ë²„íŠ¼ í‘œì‹œ */
    .chat-row:hover .delete-btn {
        opacity: 1;
    }
</style>

<script>
    const chatHistory = document.getElementById('chat-history');
    const userInput = document.getElementById('user-input');
    const sendBtn = document.getElementById('send-btn');

    // ì´ˆê¸° ìŠ¤í¬ë¡¤
    chatHistory.scrollTop = chatHistory.scrollHeight;

    async function sendMessage(event) {
        event.preventDefault();
        const text = userInput.value.trim();
        if (!text) return;

        // 1. í™”ë©´ í‘œì‹œ (ìŠ¤íƒ€ì¼ ìœ ì§€ë¥¼ ìœ„í•´ appendMessage ìˆ˜ì •ë¨)
        appendMessage('user', text);
        userInput.value = '';
        userInput.disabled = true;
        sendBtn.disabled = true;

        try {
            // 2. API í˜¸ì¶œ
            const response = await fetch('/chat/api/stream/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: text })
            });

            const reader = response.body.getReader();
            const decoder = new TextDecoder();

            let currentAiBubble = createMessageBubble('ai');
            let currentContent = "";

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;

                const chunk = decoder.decode(value, { stream: true });
                const lines = chunk.split('\n');

                for (const line of lines) {
                    if (!line.trim()) continue;
                    try {
                        const data = JSON.parse(line);

                        if (data.type === 'token') {
                            currentContent += data.content;
                            currentAiBubble.innerHTML = currentContent.replace(/\n/g, '<br>');
                        } else if (data.type === 'tool_call') {
                            createToolStatus(data.tool_name);
                        } else if (data.type === 'error') {
                            currentAiBubble.innerHTML += `<br><span style="color:red">[Error] ${data.message}</span>`;
                        }

                        chatHistory.scrollTop = chatHistory.scrollHeight;

                    } catch (e) { console.error("Parsing Error", e); }
                }
            }

        } catch (error) {
            console.error(error);
            appendMessage('ai', 'ì„œë²„ ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        } finally {
            userInput.disabled = false;
            sendBtn.disabled = false;
            userInput.focus();
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }
    }

    // [ìˆ˜ì •ë¨] DOM ìƒì„± ë¡œì§: .chat-row êµ¬ì¡°ë¥¼ ë§ì¶°ì•¼ í•¨
    function createMessageBubble(role) {
        // 1. Row ìƒì„±
        const rowDiv = document.createElement('div');
        rowDiv.className = `chat-row ${role === 'user' ? 'user-row' : 'ai-row'}`;

        // 2. ë©”ì‹œì§€ ë²„ë¸” ìƒì„±
        const msgDiv = document.createElement('div');
        msgDiv.className = `chat-message ${role === 'user' ? 'user-message' : 'ai-message'}`;

        // 3. (ì¤‘ìš”) ì‚¬ìš©ì ë©”ì‹œì§€ì¼ ê²½ìš°, JSë¡œ ì¶”ê°€ëœ ì§í›„ì—ëŠ” ì‚­ì œ ë²„íŠ¼ì„ ë³´ì—¬ì£¼ì§€ ì•ŠìŒ (IDê°€ ì—†ìœ¼ë¯€ë¡œ)
        //    ìƒˆë¡œê³ ì¹¨í•˜ë©´ IDê°€ ìƒê²¨ì„œ ë²„íŠ¼ì´ ë³´ì¼ ê²ƒì„.
        //    êµ¬ì¡°ë§Œ ë§ì¶°ì¤Œ: [ë¹ˆ ê³µê°„ í˜¹ì€ ë²„íŠ¼] + [ë©”ì‹œì§€]

        rowDiv.appendChild(msgDiv);
        chatHistory.appendChild(rowDiv);

        return msgDiv;
    }

    function appendMessage(role, text) {
        const msgDiv = createMessageBubble(role);
        msgDiv.innerText = text;
        chatHistory.scrollTop = chatHistory.scrollHeight;
    }

    function createToolStatus(toolName) {
        // ë„êµ¬ ìƒíƒœì°½ë„ Row ì•ˆì— ë„£ê±°ë‚˜ ê·¸ëƒ¥ ë‘¬ë„ ë˜ëŠ”ë°, 
        // ê¸°ì¡´ ìŠ¤íƒ€ì¼ ìœ ì§€ë¥¼ ìœ„í•´ ê·¸ëƒ¥ append (align-selfê°€ ì ìš©ë¨)
        const div = document.createElement('div');
        div.className = 'tool-status';
        div.innerHTML = `<div class="spinner"></div><span>${toolName} ë„êµ¬ë¥¼ ì‹¤í–‰ ì¤‘...</span>`;
        chatHistory.appendChild(div);
        chatHistory.scrollTop = chatHistory.scrollHeight;
    }

    // [ì‹ ê·œ] ì‚­ì œ ê¸°ëŠ¥
    async function deleteMessage(msgId) {
        if (!confirm("ì´ ì§ˆë¬¸ê³¼ ê´€ë ¨ëœ ë‹µë³€ì´ ëª¨ë‘ ì‚­ì œë©ë‹ˆë‹¤.")) return;

        try {
            const response = await fetch('/chat/api/delete/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message_id: msgId })
            });

            const result = await response.json();
            if (result.status === 'success') {
                location.reload(); // ì„±ê³µ ì‹œ ìƒˆë¡œê³ ì¹¨í•˜ì—¬ ì •ë ¬ëœ ë°ì´í„° ë‹¤ì‹œ ë¡œë“œ
            } else {
                alert("ì‚­ì œ ì‹¤íŒ¨: " + result.message);
            }
        } catch (error) {
            console.error(error);
            alert("ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        }
    }
</script>